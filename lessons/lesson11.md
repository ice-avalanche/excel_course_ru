# Урок 11. Пользовательские функции (UDF)

**Пользовательские функции (User Defined Functions, UDF)** – это функции, которые создаются пользователем на языке **VBA (Visual Basic for Applications)**.
Они работают так же, как встроенные функции Excel, но позволяют реализовать собственную бизнес-логику и автоматизировать сложные расчеты.

### Преимущества:

* Расширяют возможности Excel за счет собственного кода.
* Упрощают повторяющиеся формулы.
* Повышают читаемость и понятность моделей.
* Позволяют создавать корпоративные библиотеки расчетов.

## 1. Создание пользовательской функции

1. Открыть **Редактор VBA** – `Alt + F11`.
2. В меню выбрать **Insert → Module**.
3. Вставить код функции:

   ```vba
   Function Квадрат(Число As Double) As Double
       Квадрат = Число * Число
   End Function
   ```
4. Вернуться в Excel и ввести формулу:

   ```
   =Квадрат(A1)
   ```

   Если в `A1` значение 5 → результат **25**.

### Структура функции

```vba
Function Имя(аргументы) As Тип
    ' Тело функции
    Имя = результат
End Function
```

| Элемент                     | Описание                                                    |
| --------------------------- | ----------------------------------------------------------- |
| `Function` / `End Function` | Начало и конец блока функции                                |
| `Имя`                       | Название, под которым вызывается функция                    |
| `аргументы`                 | Данные, передаваемые из Excel                               |
| `Тип`                       | Тип возвращаемого значения (Double, String, Boolean и т.д.) |
| `Имя = результат`           | Строка возврата результата в Excel                          |

## 2. Типы аргументов и возвращаемых значений

Пользовательские функции поддерживают различные типы данных.

| Тип       | Назначение               | Пример                                         |
| --------- | ------------------------ | ---------------------------------------------- |
| `Double`  | Число с плавающей точкой | `=Округлить(3,14159)`                          |
| `String`  | Текст                    | `=Приветствие("Анна") → "Здравствуйте, Анна!"` |
| `Boolean` | Истина/Ложь              | `=Проверка(10;5) → ИСТИНА`                     |
| `Date`    | Дата и время             | `=Возраст("15.06.1995") → 30`                  |
| `Range`   | Диапазон ячеек           | `=СреднееБезНулей(A1:A10)`                     |

### Пример функции с диапазоном:

```vba
Function СреднееБезНулей(Диапазон As Range) As Double
    Dim сумма As Double, счет As Long
    Dim ячейка As Range
    For Each ячейка In Диапазон
        If IsNumeric(ячейка.Value) And ячейка.Value <> 0 Then
            сумма = сумма + ячейка.Value
            счет = счет + 1
        End If
    Next ячейка
    СреднееБезНулей = IIf(счет > 0, сумма / счет, 0)
End Function
```

## 3. Использование в формулах Excel

Пользовательская функция используется как обычная формула:

```
=ИмяФункции(аргументы)
```

Примеры:

| Формула                    | Результат           |
| -------------------------- | ------------------- |
| `=Квадрат(5)`              | 25                  |
| `=ЦенаСНДС(1000;20)`       | 1200                |
| `=СреднееБезНулей(A1:A10)` | Среднее без нулей   |
| `=Приветствие("Иван")`     | Здравствуйте, Иван! |

## 4. Обработка ошибок

Чтобы функции работали стабильно, важно предусматривать некорректный ввод и исключения.

### Пример с обработкой ошибок:

```vba
Function Деление(Число As Double, Делитель As Double) As Variant
    On Error GoTo Ошибка
    If Делитель = 0 Then
        Деление = "Ошибка: деление на ноль"
    Else
        Деление = Число / Делитель
    End If
    Exit Function
Ошибка:
    Деление = "Ошибка расчета"
End Function
```

### Полезные проверки:

| Функция         | Назначение                            |
| --------------- | ------------------------------------- |
| `IsNumeric()`   | Проверка, является ли значение числом |
| `IsDate()`      | Проверка даты                         |
| `IsEmpty()`     | Проверка пустой ячейки                |
| `On Error GoTo` | Перехват ошибок выполнения            |

## 5. Продвинутые возможности

### Возврат массива значений

```vba
Function Квадраты(Диапазон As Range) As Variant
    Dim Рез() As Double, i As Long
    ReDim Рез(1 To Диапазон.Count, 1 To 1)
    For i = 1 To Диапазон.Count
        Рез(i, 1) = Диапазон.Cells(i).Value ^ 2
    Next i
    Квадраты = Рез
End Function
```

Используется как:

```
=Квадраты(A1:A5)
```

### Условные вычисления

```vba
Function Категория(Знач As Double) As String
    Select Case Знач
        Case Is < 50: Категория = "Низкий"
        Case 50 To 80: Категория = "Средний"
        Case Else: Категория = "Высокий"
    End Select
End Function
```

### Работа с текстом

```vba
Function ОчиститьТекст(Текст As String) As String
    ОчиститьТекст = Trim(UCase(Текст))
End Function
```

## 6. Оптимизация и производительность

| Принцип                               | Объяснение                                          |
| ------------------------------------- | --------------------------------------------------- |
| **Использовать массивы вместо Range** | Считывать диапазон один раз: `Данные = Range.Value` |
| **Типизировать переменные**           | `Dim i As Long, сумма As Double`                    |
| **Избегать Application.Volatile**     | Не делать функцию волатильной без необходимости     |
| **Не использовать Format в расчетах** | Преобразует числа в текст                           |
| **Разделять большие функции**         | Несколько простых быстрее, чем одна громоздкая      |

**Пример ускоренного кода:**

```vba
Function СуммаБыстро(Диапазон As Range) As Double
    Dim D As Variant, i As Long, j As Long, s As Double
    D = Диапазон.Value
    For i = 1 To UBound(D, 1)
        For j = 1 To UBound(D, 2)
            If IsNumeric(D(i, j)) Then s = s + D(i, j)
        Next j
    Next i
    СуммаБыстро = s
End Function
```

## 7. Практическое применение

| Сфера     | Пример функции                       | Назначение                          |
| --------- | ------------------------------------ | ----------------------------------- |
| Финансы   | `KPI(Факт;План)`                     | Оценка выполнения плана             |
| Аналитика | `СреднееЕслиБольше(Диапазон;100)`    | Анализ данных по условиям           |
| Текст     | `ФорматФИО("Иванов Иван Сергеевич")` | Преобразование ФИО                  |
| Проверка  | `ПроверкаEmail(A2)`                  | Проверка корректности адреса        |
| Отчеты    | `Итог(ФИО;Сумма)`                    | Генерация подписей и итоговых строк |

## 8. Структура и тестирование кода

### Шаблон хорошо оформленной функции

```vba
' Функция: СреднееБезНулей
' Назначение: вычисляет среднее значение диапазона без нулей
' Автор: Иван
Function СреднееБезНулей(Диапазон As Range) As Double
    On Error GoTo Ошибка
    ' Проверка аргументов
    If Диапазон Is Nothing Then СреднееБезНулей = 0: Exit Function

    Dim D As Variant, i As Long, j As Long, s As Double, n As Long
    D = Диапазон.Value
    For i = 1 To UBound(D, 1)
        For j = 1 To UBound(D, 2)
            If IsNumeric(D(i, j)) And D(i, j) <> 0 Then
                s = s + D(i, j): n = n + 1
            End If
        Next j
    Next i
    СреднееБезНулей = IIf(n > 0, s / n, 0)
    Exit Function
Ошибка:
    СреднееБезНулей = 0
End Function
```

### Проверка функции:

1. Открыть окно **Immediate** (Ctrl+G).
2. Ввести:

   ```vba
   ?СреднееБезНулей(Range("A1:A10"))
   ```
3. Результат отобразится внизу.

## 9. Рекомендации

* Начинать с простых функций и отлаживать пошагово.
* Добавлять комментарии к каждому логическому блоку.
* Использовать `Option Explicit`, т.к. это предотвратит ошибки из-за опечаток.
* Собрать функции в отдельные модули по темам: `TextUtils`, `Finance`, `Validation`.
* Хранить рабочие функции в надстройке `.xlam`, чтобы использовать их во всех файлах.
* Для сложных расчетов лучше возвращать **Variant** и обрабатывать тип результата внутри.
