# Урок 9. Макросы

**Макросы** – это инструмент Excel для **автоматизации повторяющихся действий**.  
Макрос записывает последовательность шагов пользователя (форматирование, сортировка, обновление таблиц и т.д.) и позволяет выполнять их одним кликом или автоматически.

Использование макросов позволяет:
- сократить время на рутинные операции;
- снизить риск ошибок при повторении шагов;
- обеспечить единообразие оформления и расчетов;
- создавать собственные инструменты и интерфейсы.

## 1. Запись и выполнение макросов

Excel позволяет записывать макросы без программирования – действия пользователя автоматически преобразуются в команды VBA.

### Включение вкладки «Разработчик»

1. Открыть меню **Файл → Параметры → Настроить ленту**.  
2. Установить флажок **Разработчик (Developer)**.  
3. Нажать **ОК** – вкладка появится на ленте.

### Запись макроса

1. Перейти на вкладку **Разработчик → Записать макрос**.  
2. Указать:
   - имя макроса (например, `FormatReport`);
   - сочетание клавиш (опционально);
   - место хранения (в этой книге, в личной книге макросов или в новой).  
3. Выполнить действия (например, форматирование таблицы).  
4. Нажать **Остановить запись**.

**Пример макроса:**

```vba
Sub FormatHeader()
    Rows("1:1").Font.Bold = True
    Cells.EntireColumn.AutoFit
End Sub
````

### Запуск макроса

| Способ                                  | Действие                                                |
| --------------------------------------- | ------------------------------------------------------- |
| Через вкладку **Разработчик → Макросы** | Выбрать макрос и нажать **Выполнить**                   |
| Через сочетание клавиш                  | Использовать комбинацию, заданную при записи            |
| Через кнопку на листе                   | Вставить элемент **Формы → Кнопка**, назначить макрос   |
| Автоматически                           | Использовать событие `Workbook_Open` при открытии книги |

### Режим относительных ссылок

По умолчанию Excel записывает макрос с **абсолютными ссылками**.
Чтобы действия выполнялись относительно активной ячейки, нужно включить режим **Использовать относительные ссылки** на вкладке **Разработчик**.

## 2. Форматы и безопасность макросов

Макросы сохраняются только в файлах, поддерживающих код VBA.

| Формат  | Назначение                                                 |
| ------- | ---------------------------------------------------------- |
| `.xlsm` | Книга с поддержкой макросов                                |
| `.xltm` | Шаблон с макросами                                         |
| `.xlam` | Надстройка Excel                                           |
| `.xlsb` | Двоичная книга (компактный формат с возможностью макросов) |

### Безопасность макросов

Чтобы защитить систему от вредоносных скриптов, Excel по умолчанию блокирует неизвестные макросы.

**Путь к настройкам:**
**Файл → Параметры → Центр управления безопасностью → Параметры центра → Параметры макросов**

| Режим                      | Поведение                                           |
| -------------------------- | --------------------------------------------------- |
| Отключить без уведомления  | Полный запрет                                       |
| Отключить с уведомлением   | Показывает полосу «Включить содержимое»             |
| Только подписанные макросы | Разрешает код с цифровой подписью                   |
| Включить все макросы       | Безопасность отключена (только в доверенных файлах) |

### Доверенные расположения

Чтобы Excel не запрашивал подтверждение при каждом открытии:

1. Открыть **Центр управления безопасностью → Доверенные расположения**.
2. Добавить папку, где хранятся ваши файлы с макросами.
3. Все книги из этой папки будут открываться без предупреждений.

## 3. Привязка макросов к интерфейсу

Для удобства макрос можно связать с элементами интерфейса Excel.

### Кнопка на листе

1. Вкладка **Разработчик → Вставить → Элементы управления формы → Кнопка**.
2. Нарисовать кнопку на листе.
3. Выбрать макрос и нажать **ОК**.
4. Изменить текст кнопки (например, *«Оформить отчет»*).

### Панель быстрого доступа

1. Правый клик на панели → **Настроить панель быстрого доступа**.
2. Выбрать **Макросы** и добавить нужный.
3. Изменить иконку и подпись.

### Сочетание клавиш

1. Вкладка **Разработчик → Макросы → Параметры**.
2. Назначить комбинацию (`Ctrl+Shift+R` и т.п.).

### Автозапуск при открытии

Код можно разместить в модуле `ThisWorkbook`:

```vba
Private Sub Workbook_Open()
    MsgBox "Файл готов к работе!"
    Call FormatHeader
End Sub
```

## 4. Основы VBA-кода

VBA (Visual Basic for Applications) – язык, на котором записываются макросы.
Понимание структуры кода позволяет редактировать и создавать собственные процедуры.

### Структура процедуры

```vba
Sub ИмяМакроса()
    ' Комментарии начинаются с апострофа
    ' Основные действия
End Sub
```

### Основные объекты Excel

| Объект         | Пример                         | Описание                 |
| -------------- | ------------------------------ | ------------------------ |
| `Range`        | `Range("A1").Value = 10`       | Ячейка или диапазон      |
| `Cells`        | `Cells(2, 1).Value = "Пример"` | Обращение по координатам |
| `ActiveSheet`  | `ActiveSheet.Name = "Отчет"`   | Активный лист            |
| `ThisWorkbook` | `ThisWorkbook.Save`            | Текущая книга            |

### Пример: обновление сводных таблиц

```vba
Sub RefreshAllPivots()
    Dim ws As Worksheet, pt As PivotTable
    For Each ws In ThisWorkbook.Worksheets
        For Each pt In ws.PivotTables
            pt.RefreshTable
        Next pt
    Next ws
    MsgBox "Все сводные таблицы обновлены!"
End Sub
```

### Пример: автоматическое оформление отчета

```vba
Sub FormatReport()
    With Rows("1:1")
        .Font.Bold = True
        .Interior.Color = RGB(220, 230, 241)
    End With
    Cells.EntireColumn.AutoFit
End Sub
```

## 5. Типичные ошибки и советы

| Ошибка                   | Причина                                   | Решение                                                |
| ------------------------ | ----------------------------------------- | ------------------------------------------------------ |
| Макрос не запускается    | Макросы отключены                         | Включить содержимое при открытии                       |
| Файл `.xlsx`             | Формат не поддерживает макросы            | Сохранить как `.xlsm`                                  |
| “Subscript out of range” | Неверное имя листа/файла                  | Проверить правильность ссылок                          |
| Бесконечный цикл         | Ошибка в логике `Do While`                | Добавить счетчик или выход из цикла                    |
| Замедление работы        | Избыточные `Select` и экранное обновление | Использовать прямые ссылки, отключить `ScreenUpdating` |
