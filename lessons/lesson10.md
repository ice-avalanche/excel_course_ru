# Урок 10. Основы VBA

**VBA (Visual Basic for Applications)** – это встроенный язык программирования в Microsoft Excel и других приложениях Office.
Он позволяет автоматизировать повторяющиеся действия, создавать собственные функции, диалоговые формы и даже полноценные мини-приложения.

### Основные возможности VBA

| Возможность                  | Пример применения                                                  |
| ---------------------------- | ------------------------------------------------------------------ |
| **Автоматизация**            | Ежедневное обновление отчета, форматирование таблиц, расчет итогов |
| **Создание макросов**        | Выполнение действий нажатием одной кнопки                          |
| **Пользовательские функции** | Собственные формулы, недоступные в стандартном наборе Excel        |
| **Формы и интерфейсы**       | Окна с полями ввода, списками, кнопками                            |
| **Интеграция с Office**      | Управление Word, Outlook, PowerPoint из Excel                      |

### Где хранится код VBA

Код пишется в специальном редакторе **VBE (Visual Basic Editor)** и хранится:

* внутри книги Excel формата **`.xlsm`**;
* в **модулях**, **листах** или **формах**;
* в **надстройках** `.xlam` – для распространения функций и инструментов.

## 1. Интерфейс редактора VBA (VBE)

Редактор открывается комбинацией **Alt + F11**.

### Основные окна:

| Элемент                       | Назначение                                                         |
| ----------------------------- | ------------------------------------------------------------------ |
| **Project Explorer (Ctrl+R)** | Список всех открытых книг и их объектов (листы, формы, модули)     |
| **Code Window**               | Окно, где пишется сам код                                          |
| **Properties Window (F4)**    | Изменение свойств выделенного объекта (имя, заголовок, цвет и др.) |
| **Immediate Window (Ctrl+G)** | Быстрая проверка команд и отладка                                  |
| **Toolbar и меню**            | Кнопки запуска, остановки и пошагового выполнения кода             |

### Практика:

1. Открыть книгу Excel → **Alt + F11**.
2. В меню **Insert → Module** создать новый модуль.
3. Ввести:

   ```vba
   Sub HelloWorld()
       MsgBox "Привет, Excel!"
   End Sub
   ```
4. Вернуться в Excel → **Alt + F8 → HelloWorld → Выполнить**.

Результат – всплывающее окно с сообщением “Привет, Excel!”.

## 2. Структура программы на VBA

Код на VBA состоит из **процедур** (Sub) и **функций** (Function).

### Процедура (Sub)

Используется для выполнения действий:

```vba
Sub Пример()
    Range("A1").Value = "Привет"
    Range("A1").Font.Bold = True
End Sub
```

### Функция (Function)

Возвращает значение, которое можно использовать в формулах Excel:

```vba
Function Квадрат(x As Double) As Double
    Квадрат = x * x
End Function
```

В Excel можно ввести формулу:

```
=Квадрат(5) → 25
```

### Комментарии

Любая строка, начинающаяся с апострофа `'`, считается комментарием:

```vba
' Это комментарий
```

## 3. Переменные и типы данных

Переменные хранят значения, которые программа использует в вычислениях.

### Объявление переменных

```vba
Dim имя As Тип
```

### Основные типы данных

| Тип       | Назначение                       | Пример                |
| --------- | -------------------------------- | --------------------- |
| `Integer` | Целое число                      | `Dim i As Integer`    |
| `Long`    | Большое целое                    | `Dim n As Long`       |
| `Double`  | Десятичное число                 | `Dim x As Double`     |
| `String`  | Текст                            | `Dim s As String`     |
| `Boolean` | Логическое значение              | `Dim flag As Boolean` |
| `Variant` | Универсальный тип (по умолчанию) | `Dim v`               |
| `Date`    | Дата и время                     | `Dim d As Date`       |

### Пример

```vba
Sub Переменные()
    Dim имя As String, сумма As Double
    имя = "Андрей"
    сумма = 12345.6
    MsgBox имя & ": " & сумма & " ₽"
End Sub
```

## 4. Управляющие конструкции и циклы

Позволяют выполнять код при выполнении условий или многократно.

### Условные операторы

```vba
If условие Then
    ' код
ElseIf другое_условие Then
    ' другой код
Else
    ' иначе
End If
```

Пример:

```vba
If Range("B2").Value > 1000 Then
    MsgBox "Премия!"
Else
    MsgBox "Без премии."
End If
```

### Циклы

**For…Next** – повтор определенное число раз:

```vba
For i = 1 To 10
    Cells(i, 1).Value = i
Next i
```

**For Each** – перебор объектов:

```vba
For Each c In Range("A1:A5")
    c.Value = UCase(c.Value)
Next c
```

**Do While / Loop** – пока выполняется условие:

```vba
Do While Cells(i, 1).Value <> ""
    i = i + 1
Loop
```

## 5. Работа с диапазонами и ячейками

Основной объект Excel – **Range**.

| Пример                                                                          | Действие                     |
| ------------------------------------------------------------------------------- | ---------------------------- |
| `Range("A1").Value = 10`                                                        | Записать значение            |
| `Range("A1").Font.Bold = True`                                                  | Сделать шрифт жирным         |
| `Cells(2,3).Value = "Пример"`                                                   | Ячейка C2                    |
| `Range("A1:B5").ClearContents`                                                  | Очистить диапазон            |
| `ActiveCell.Offset(1,0).Select`                                                 | Переместиться на строку ниже |
| `With Range("A1:B1") .Font.Bold=True .Interior.Color=RGB(200,230,255) End With` | Групповое форматирование     |

## 6. Взаимодействие с пользователем

Для вывода сообщений и ввода данных используются **MsgBox** и **InputBox**.

### Сообщения

```vba
MsgBox "Операция завершена!"
```

С кнопками:

```vba
Dim ответ As VbMsgBoxResult
ответ = MsgBox("Очистить таблицу?", vbYesNo + vbQuestion, "Подтверждение")
If ответ = vbYes Then Range("A2:D100").ClearContents
```

### Ввод данных

```vba
Dim имя As String
имя = InputBox("Введите имя пользователя:")
MsgBox "Здравствуйте, " & имя & "!"
```

## 7. Примеры практических макросов

### Пример 1. Очистка диапазона

```vba
Sub ОчиститьТаблицу()
    Range("A2:D1000").ClearContents
    MsgBox "Данные удалены."
End Sub
```

### Пример 2. Автоматическое форматирование заголовков

```vba
Sub ФорматироватьЗаголовки()
    With Range("A1:D1")
        .Font.Bold = True
        .Interior.Color = RGB(180, 210, 250)
        .HorizontalAlignment = xlCenter
    End With
End Sub
```

### Пример 3. Добавление текущей даты

```vba
Sub ДобавитьДату()
    ActiveCell.Value = Date
    ActiveCell.NumberFormat = "ДД.ММ.ГГГГ"
End Sub
```

## 8. Рекомендации по работе с VBA

| Совет                                     | Почему важно                                    |
| ----------------------------------------- | ----------------------------------------------- |
| **Сохраняйте копию файла перед тестами**  | Ошибки кода могут изменить данные               |
| **Комментируйте код**                     | Облегчает поддержку                             |
| **Избегайте `.Select` и `.Activate`**     | Замедляют выполнение                            |
| **Используйте `Option Explicit`**         | Заставляет объявлять переменные (меньше ошибок) |
| **Используйте модули и подпрограммы**     | Код становится структурированным                |
| **Отлаживайте через F8 и окно Immediate** | Позволяет поэтапно проверять логику             |
