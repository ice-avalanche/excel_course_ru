# Урок 8. Power Query: импорт и преобразование данных

## 1. Назначение Power Query

**Power Query** – это инструмент для импорта, очистки и объединения данных из разных источников.
Он автоматизирует рутинные операции и позволяет создавать **пошаговый конвейер обработки данных**, который можно обновлять одним кликом.

Power Query часто называют **ETL-инструментом**:

* **E (Extract)** – извлечение данных из источников;
* **T (Transform)** – преобразование и очистка данных;
* **L (Load)** – загрузка обратно в Excel, Power Pivot или модель данных.

### Преимущества:

* Автоматизация ручных действий (удаление дублей, фильтрация, объединение и т. д.);
* Поддержка десятков источников (Excel, CSV, SQL, Web, SharePoint, API);
* Пошаговое редактирование и история изменений;
* Возможность объединять данные из разных файлов и папок;
* Интеграция с Power BI и Моделью данных Excel.

## 2. Импорт данных

### 2.1. Из файлов Excel

1. Вкладка **Данные → Получить данные → Из файла → Из книги Excel**.
2. Указать путь к файлу → выбрать лист или таблицу.
3. Нажать **Трансформировать данные** (открыть редактор Power Query).

### 2.2. Из CSV или текстовых файлов

**Данные → Получить данные → Из файла → Из текстового/CSV**.
Power Query автоматически распознает разделитель (запятая, точка с запятой, табуляция).
Можно изменить кодировку и типы столбцов перед загрузкой.

### 2.3. Из папки (для объединения файлов)

1. **Данные → Получить данные → Из папки.**
2. Указать путь с однотипными файлами (например, ежемесячные отчеты).
3. Нажать **Объединить** – Power Query создаст единый набор данных.

### 2.4. Из интернета

**Данные → Получить данные → Из Интернета** – вставить ссылку (например, на таблицу со статистикой).
Поддерживаются сайты с HTML-таблицами и открытые API.

## 3. Редактор Power Query

### Основные области интерфейса:

| Элемент                      | Назначение                                                             |
| ---------------------------- | ---------------------------------------------------------------------- |
| **Область запросов (слева)** | Список всех подключений и шагов обработки                              |
| **Центральная таблица**      | Отображает текущие данные после каждого шага                           |
| **Панель шагов (справа)**    | Последовательность примененных операций                                |
| **Лента инструментов**       | Команды импорта, фильтрации, преобразования, группировки и объединения |

Каждое действие (удалить столбец, заменить значение, изменить тип данных и т. д.) сохраняется как отдельный шаг и может быть изменено в любой момент.

## 4. Базовые преобразования

| Операция                                 | Действие                                           | Пример                              |
| ---------------------------------------- | -------------------------------------------------- | ----------------------------------- |
| **Переименование столбцов**              | Двойной щелчок по заголовку                        | `Дата_продажи → Дата`               |
| **Изменение типа данных**                | Выбрать иконку в заголовке (123 / ABC / календарь) | `Текст → Дата`                      |
| **Удаление строк**                       | Главная → Удалить строки                           | Первые N, последние N, пустые       |
| **Удаление дубликатов**                  | Главная → Удалить дубликаты                        | По выбранным столбцам               |
| **Фильтрация**                           | Стрелка в заголовке                                | Исключить или выбрать значения      |
| **Разделение столбца**                   | Преобразование → Разделить столбец                 | По разделителю (`;`, `,`)           |
| **Объединение столбцов**                 | Преобразование → Объединить столбцы                | «Фамилия Имя Отчество»              |
| **Извлечение текста**                    | Преобразование → Извлечь                           | Первые/последние символы, подстрока |
| **Добавление пользовательского столбца** | Добавление столбца → Пользовательский              | `=[Количество]*[Цена]`              |
| **Замена значений**                      | ПКМ по ячейке → Заменить значения                  | `NULL → 0`                          |

## 5. Группировка и агрегирование

**Главная → Группировать по**

| Параметр              | Пример                     |
| --------------------- | -------------------------- |
| **Группировать по**   | «Регион»                   |
| **Операция**          | Сумма, Среднее, Количество |
| **Новое имя столбца** | «Выручка_по_регионам»      |

## 6. Объединение запросов

Power Query позволяет **объединять таблицы**, как в SQL.

| Тип объединения  | Описание                              | Пример                       |
| ---------------- | ------------------------------------- | ---------------------------- |
| **Объединение**  | Сопоставляет строки по ключевому полю | Сведения о клиентах + заказы |
| **Добавление**   | Склеивает таблицы друг под другом     | Январь + Февраль + Март      |

### Пример:

1. **Главная → Объединить запросы → Объединить.**
2. Выбрать таблицы и поле связи (например, `ID_Клиента`).
3. Настроить тип объединения: внутреннее, левое, правое, полное, антипересечение.
4. Развернуть добавленную таблицу, выбрав нужные столбцы.

## 7. Условные столбцы и логика

**Добавление столбца → Условный столбец.**
Пример:

| Условие                        | Значение  |
| ------------------------------ | --------- |
| Если `[Продажи] > 100000`      | «Высокие» |
| Иначе если `[Продажи] > 50000` | «Средние» |
| Иначе                          | «Низкие»  |

## 8. Трансформация и разворот данных

| Действие                         | Описание                                             | Пример                         |
| -------------------------------- | ---------------------------------------------------- | ------------------------------ |
| **Поворот столбцов (Pivot)**     | Преобразует уникальные значения в заголовки столбцов | Годы → столбцы                 |
| **Транспонирование**             | Меняет строки и столбцы местами                      | Упрощение структуры            |
| **Заполнение вниз / вверх**      | Заполняет пропуски значением из соседней строки      | Даты в отчетах                 |
| **Извлечение года, месяца, дня** | Для столбцов с датой                                 | `2025`, `Март`, `15`           |

## 9. Загрузка результатов

После всех преобразований:

1. Нажать **Главная → Закрыть и загрузить**.
2. Выбрать:

   * **Создать подключение** – если нужно использовать в других запросах;
   * **В таблицу на листе** – загрузка готовых данных в Excel;
   * **В модель данных** – для работы со сводными таблицами и DAX.

## 10. Пример конвейера Power Query

**Цель:** собрать ежемесячные отчеты из папки и рассчитать выручку по регионам.

1. **Импорт → Из папки** (с отчетами за месяцы).
2. **Объединить файлы** → таблица со всеми данными.
3. **Удалить пустые строки и ненужные столбцы.**
4. **Преобразовать типы** (дата, число).
5. **Добавить столбец «Месяц» = `Date.MonthName([Дата])`.**
6. **Группировать по «Регион»** → Сумма выручки.
7. **Закрыть и загрузить** → новая таблица в Excel.
8. При добавлении новых файлов в папку достаточно нажать **Обновить**.

## 11. Интеграция с другими инструментами

| Инструмент                          | Возможности                                |
| ----------------------------------- | ------------------------------------------ |
| **Сводные таблицы**                 | Использовать запрос как источник данных    |
| **Power Pivot / Модель данных**     | Построение отношений между таблицами       |
| **Power BI**                        | Передача готовых запросов для визуализации |
| **Excel-функции**                   | Работа с загруженными результатами         |
| **VBA / Макросы**                   | Автоматизация обновления запросов          |

## 12. Рекомендации

* По возможности **не изменять исходные файлы вручную**, т.к. Power Query сделает все автоматически.
* Использовать **осмысленные имена шагов и запросов**.
* Проверять **типы данных** после импорта, особенно даты и числа.
* Избегать громоздких формул, лучше создать отдельные столбцы с вычислениями.
* Хранить все файлы с одинаковой структурой, если используете объединение из папки.
* Настроить обновление данных при открытии файла для автоматизации отчетов.
