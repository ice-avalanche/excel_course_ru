# Урок 13. Создание приложений в Excel

## 1. Назначение

Excel позволяет создавать не только таблицы и отчёты, но и полноценные **мини-приложения** с интерфейсом, логикой расчётов и автоматизацией.

Приложение в Excel – это файл `.xlsm`, который:

- содержит элементы управления (кнопки, списки, поля ввода);
- использует макросы и процедуры VBA;
- выполняет расчёты по заданной бизнес-логике;
- взаимодействует с пользователем через формы;
- может использоваться как рабочий инструмент (калькулятор, планировщик, система учёта).

## 2. Архитектура приложения в Excel

Простейшая структура:

```
Интерфейс (лист)
↓
Элементы управления
↓
Макросы / процедуры VBA
↓
Расчётная логика
↓
Вывод результата

```

### Основные компоненты

| Компонент | Назначение |
|------------|------------|
| Листы Excel | Хранение данных |
| Элементы формы | Управление параметрами |
| VBA-модуль | Логика расчётов |
| UserForm | Отдельное диалоговое окно |
| Кнопки | Запуск действий |

## 3. Разделение логики и интерфейса

Рекомендуемая структура:

| Лист | Назначение |
|------|------------|
| `Data` | Исходные данные |
| `Calc` | Формулы и расчёты |
| `UI` | Интерфейс пользователя |

### Принцип:
- Пользователь работает только с листом `UI`.
- Формулы и расчёты скрыты.
- Данные защищены от случайного изменения.

## 4. Создание пользовательской формы (UserForm)

### Добавление формы

1. Открыть VBA (`Alt + F11`).
2. **Insert → UserForm**.
3. Добавить элементы:
   - Label (подпись);
   - TextBox (ввод данных);
   - ComboBox (выбор);
   - CommandButton (кнопка).

### Пример: калькулятор кредита

#### Элементы формы:

| Элемент | Назначение |
|----------|------------|
| TextBox1 | Сумма кредита |
| TextBox2 | Процентная ставка |
| TextBox3 | Срок |
| CommandButton1 | Рассчитать |

### Код кнопки:

```vba
Private Sub CommandButton1_Click()

    Dim S As Double
    Dim r As Double
    Dim n As Double
    Dim payment As Double

    S = CDbl(TextBox1.Value)
    r = CDbl(TextBox2.Value) / 100 / 12
    n = CDbl(TextBox3.Value) * 12

    payment = S * r / (1 - (1 + r) ^ (-n))

    MsgBox "Ежемесячный платёж: " & Format(payment, "# ##0.00 ₽")

End Sub
```

## 5. Связь формы и листа

Форма может:

* записывать данные в ячейки;
* читать данные из таблицы;
* запускать расчётные процедуры.

### Пример:

```vba
Range("B2").Value = TextBox1.Value
```

или

```vba
TextBox1.Value = Range("B2").Value
```

## 6. Запуск приложения

### Способ 1. Через макрос

```vba
Sub OpenApp()
    UserForm1.Show
End Sub
```

Кнопка на листе → назначить `OpenApp`.

### Способ 2. Автоматический запуск при открытии

В `ThisWorkbook`:

```vba
Private Sub Workbook_Open()
    UserForm1.Show
End Sub
```

## 7. Обработка ошибок

Любое приложение должно быть устойчивым к ошибкам ввода.

```vba
If Not IsNumeric(TextBox1.Value) Then
    MsgBox "Введите корректную сумму!"
    Exit Sub
End If
```

или

```vba
On Error GoTo ErrHandler
```

## 8. Улучшение интерфейса

### Настройки формы:

| Свойство        | Назначение     |
| --------------- | -------------- |
| Caption         | Заголовок окна |
| BackColor       | Цвет фона      |
| StartUpPosition | Центрирование  |
| Font            | Шрифт          |

### Пример:

```vba
UserForm1.BackColor = RGB(240,240,240)
```

## 9. Создание бизнес-приложений

Примеры практических задач:

| Приложение            | Назначение               |
| --------------------- | ------------------------ |
| Калькулятор NPV/IRR   | Инвестиционный анализ    |
| План-факт модуль      | Контроль бюджета         |
| Система ввода заявок  | Учёт операций            |
| Кредитный калькулятор | Финансовое моделирование |
| KPI-панель            | Мониторинг показателей   |

## 10. Защита приложения

### Рекомендации:

* Скрыть листы с расчётами (`VeryHidden`).
* Защитить структуру книги.
* Заблокировать редактирование VBA-проекта паролем.
* Использовать цифровую подпись при распространении.

## 11. Оптимизация и структура кода

Рекомендуется:

* Использовать `Option Explicit`.
* Разделять код по модулям (`Finance`, `Utils`, `UI`).
* Не дублировать код.
* Использовать процедуры вместо длинных блоков.

Пример структуры:

```vba
Sub MainCalculation()
    Call ReadData
    Call Calculate
    Call ShowResult
End Sub
```
